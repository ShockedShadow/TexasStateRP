<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSRP Staff Dashboard</title>
    <style>
        :root { --bg: #050508; --accent: #3A86FF; --card: rgba(255, 255, 255, 0.05); }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Screens */
        #login-screen { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        #main-content { display: none; padding: 20px; }

        /* UI Elements */
        .btn-discord { background: #5865F2; color: white; padding: 15px 30px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; }
        .user-profile { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding: 15px; background: var(--card); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .user-profile img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent); }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        .btn-logout { background: transparent; color: #ff4444; border: 1px solid #ff4444; padding: 10px; border-radius: 8px; width: 100%; margin-top: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="../logo.png" width="80" alt="Logo" style="margin-bottom: 15px;">
        <h2 id="status-text">Staff Dashboard</h2>
        <p id="sub-text" style="color: #666; margin-bottom: 25px;">Please authenticate to continue</p>
        <button class="btn-discord" id="login-btn" onclick="loginWithDiscord()">Login with Discord</button>
    </div>

    <div id="main-content">
        <div class="user-profile">
            <img id="user-avatar" src="" alt="Avatar">
            <div>
                <div id="user-name" style="font-weight: bold; font-size: 1.1rem;">User</div>
                <small id="user-role" style="color: var(--accent);">Authorized Staff</small>
            </div>
        </div>

        <h3>Staff Tools</h3>
        <div class="card">üìã Log Patrol Session</div>
        <div class="card">üõ°Ô∏è Disciplinary Action</div>
        <div class="card">üîç Database Lookup</div>

        <button class="btn-logout" onclick="logout()">LOG OUT</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '1268561572230332580'; 
        const GUILD_ID = '1422943051126411276'; 
        const STAFF_ROLE_ID = '1422943051504160961'; 
        const REDIRECT_URI = 'https://shockedshadow.github.io/TexasStateRP/dashboard/';

        function loginWithDiscord() {
            const scope = encodeURIComponent('identify guilds.members.read');
            window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${scope}`;
        }

        function logout() {
            window.location.hash = "";
            window.location.href = window.location.pathname;
        }

        window.onload = async () => {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');

            if (accessToken) {
                // Update UI to show we are checking
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('status-text').innerText = "Verifying...";
                document.getElementById('sub-text').innerText = "Checking Staff Permissions";

                try {
                    // Fetch server member info
                    const response = await fetch(`https://discord.com/api/users/@me/guilds/${GUILD_ID}/member`, {
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });
                    
                    if (!response.ok) throw new Error("Not in server");
                    const memberData = await response.json();

                    // Check for Role
                    if (memberData.roles && memberData.roles.includes(STAFF_ROLE_ID)) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('main-content').style.display = 'block';
                        document.getElementById('user-name').innerText = memberData.user.username;
                        document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${memberData.user.id}/${memberData.user.avatar}.png`;
                    } else {
                        document.getElementById('status-text').innerText = "Access Denied";
                        document.getElementById('sub-text').innerHTML = "<b style='color:red'>You do not have the required Staff Role.</b>";
                    }
                } catch (err) {
                    document.getElementById('status-text').innerText = "Auth Error";
                    document.getElementById('sub-text').innerText = "Are you in the Discord server?";
                    document.getElementById('login-btn').style.display = 'block';
                }
            }
        };
    </script>
</body>
</html>
